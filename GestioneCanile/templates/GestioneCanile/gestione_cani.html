{% extends 'GestioneCanile/base.html' %}

{% block title %}Gestione Cani - Gestione Canile{% endblock %}

{% block content %}
<h1 class="mb-4">Gestione Cani</h1>

<!-- Filtri e ricerca -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="q" class="form-label">Cerca</label>
                <input type="text" class="form-control" id="q" name="q" value="{{ query }}" placeholder="Nome, razza o microchip...">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">Tutti gli status</option>
                    <option value="disponibile" {% if status == 'disponibile' %}selected{% endif %}>Disponibile</option>
                    <option value="in_adozione" {% if status == 'in_adozione' %}selected{% endif %}>In processo di adozione</option>
                    <option value="adottato" {% if status == 'adottato' %}selected{% endif %}>Adottato</option>
                    <option value="in_cura" {% if status == 'in_cura' %}selected{% endif %}>In cura</option>
                    <option value="non_adottabile" {% if status == 'non_adottabile' %}selected{% endif %}>Non adottabile</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="canile" class="form-label">Canile</label>
                <select class="form-select" id="canile" name="canile">
                    <option value="">Tutti i canili</option>
                    {% for canile in canili %}
                    <option value="{{ canile.id }}" {% if canile.id|stringformat:"i" == canile_id %}selected{% endif %}>{{ canile.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Filtra</button>
            </div>
        </form>
    </div>
</div>

<!-- Ordinamento -->
<div class="mb-3">
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            Ordina per
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item {% if sort_by == '-data_ingresso' %}active{% endif %}" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort=-data_ingresso">Più recenti</a></li>
            <li><a class="dropdown-item {% if sort_by == 'data_ingresso' %}active{% endif %}" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort=data_ingresso">Più vecchi</a></li>
            <li><a class="dropdown-item {% if sort_by == 'nome' %}active{% endif %}" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort=nome">Nome (A-Z)</a></li>
            <li><a class="dropdown-item {% if sort_by == '-nome' %}active{% endif %}" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort=-nome">Nome (Z-A)</a></li>
        </ul>
    </div>
    <a href="#" class="btn btn-success ms-2">
        <i class="fas fa-plus"></i> Aggiungi Cane
    </a>
    <a href="{% url 'import_cani' %}" class="btn btn-info ms-2">
        <i class="fas fa-file-import"></i> Importa Cani da CSV
    </a>
</div>

<!-- Lista cani -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Razza</th>
                <th>Età</th>
                <th>Sesso</th>
                <th>Status</th>
                <th>Canile</th>
                <th>Data Ingresso</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody>
            {% for cane in page_obj %}
            <tr>
                <td>{{ cane.id }}</td>
                <td>{{ cane.nome }}</td>
                <td>{{ cane.razza }}</td>
                <td>{% if cane.eta %}{{ cane.eta }} anni{% else %}N/D{% endif %}</td>
                <td>{{ cane.get_sesso_display }}</td>
                <td>
                    <span class="badge {% if cane.status == 'disponibile' %}bg-success{% elif cane.status == 'in_adozione' %}bg-warning text-dark{% elif cane.status == 'adottato' %}bg-info{% elif cane.status == 'in_cura' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ cane.get_status_display }}
                    </span>
                </td>
                <td>{{ cane.canile.nome }}</td>
                <td>{{ cane.data_ingresso }}</td>
                <td>
                    <div class="btn-group">
                        <a href="{% url 'dettaglio_cane' cane.id %}" class="btn btn-sm btn-outline-primary">Dettagli</a>
                        <a href="{% url 'registro_sanitario' cane.id %}" class="btn btn-sm btn-outline-danger">Registro Sanitario</a>
                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Modifica</a></li>
                            <li><a class="dropdown-item" href="#">Cambia Status</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#">Elimina</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center">Non ci sono cani con i criteri selezionati.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginazione -->
{% if page_obj.has_other_pages %}
<nav aria-label="Paginazione">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort={{ sort_by }}&page=1">&laquo; Prima</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort={{ sort_by }}&page={{ page_obj.previous_page_number }}">Precedente</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&laquo; Prima</span>
        </li>
        <li class="page-item disabled">
            <span class="page-link">Precedente</span>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
            <span class="page-link">{{ num }}</span>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
            <a class="page-link" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort={{ sort_by }}&page={{ num }}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort={{ sort_by }}&page={{ page_obj.next_page_number }}">Successiva</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?q={{ query }}&status={{ status }}&canile={{ canile_id }}&sort={{ sort_by }}&page={{ page_obj.paginator.num_pages }}">Ultima &raquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">Successiva</span>
        </li>
        <li class="page-item disabled">
            <span class="page-link">Ultima &raquo;</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<div class="mt-4">
    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Torna alla Dashboard</a>
</div>
{% endblock %}
