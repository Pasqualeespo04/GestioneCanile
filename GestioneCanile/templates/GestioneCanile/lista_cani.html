{% extends 'GestioneCanile/base.html' %}

{% block title %}Adotta un cane - Gestione Canile{% endblock %}

{% block content %}
<div class="py-4 position-relative">
    <div class="position-absolute" style="top: 0; left: 0; right: 0; height: 200px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); opacity: 0.05; z-index: -1;"></div>

    <div class="container">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold"><i class="fas fa-paw text-primary me-2"></i>Adotta un amico</h1>
            <p class="lead">Trova il compagno perfetto per la tua famiglia tra i nostri amici a quattro zampe</p>
        </div>

        <div class="row">
            <!-- Contenuto principale: lista cani -->
            <div class="col-lg-9">
                <!-- Ordinamento e conteggio risultati -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <p class="mb-0">
                        <span class="badge bg-primary rounded-pill px-3 py-2 shadow-sm">
                            <i class="fas fa-dog me-1"></i> {{ page_obj.paginator.count }} cani trovati
                        </span>
                    </p>
                    <div class="dropdown">
                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-sort me-1"></i> Ordina per
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                            <li><a class="dropdown-item {% if sort_by == '-data_ingresso' %}active{% endif %}" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort=-data_ingresso"><i class="fas fa-calendar-alt me-2"></i>Più recenti</a></li>
                            <li><a class="dropdown-item {% if sort_by == 'data_ingresso' %}active{% endif %}" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort=data_ingresso"><i class="fas fa-calendar-alt me-2"></i>Più vecchi</a></li>
                            <li><a class="dropdown-item {% if sort_by == 'nome' %}active{% endif %}" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort=nome"><i class="fas fa-sort-alpha-down me-2"></i>Nome (A-Z)</a></li>
                            <li><a class="dropdown-item {% if sort_by == '-nome' %}active{% endif %}" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort=-nome"><i class="fas fa-sort-alpha-up-alt me-2"></i>Nome (Z-A)</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Lista cani -->
                <div class="row g-4">
                    {% for cane in page_obj %}
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm rounded-3 overflow-hidden position-relative">
                            <!-- Badge di genere e stato -->
                            <div class="position-absolute d-flex gap-2" style="top: 10px; right: 10px; z-index: 10;">
                                <span class="badge bg-primary rounded-pill px-3 py-2 shadow-sm">
                                    <i class="fas fa-{% if cane.sesso == 'M' %}mars{% else %}venus{% endif %} me-1"></i>
                                    {{ cane.get_sesso_display }}
                                </span>
                                <span class="badge bg-{% if cane.status == 'disponibile' %}success{% elif cane.status == 'in_adozione' %}warning{% else %}secondary{% endif %} rounded-pill px-3 py-2 shadow-sm">
                                    {{ cane.get_status_display }}
                                </span>
                            </div>

                            <!-- Immagine del cane -->
                            <div class="position-relative" style="height: 250px; overflow: hidden;">
                                {% if cane.foto %}
                                <img src="{{ cane.foto.url }}" class="w-100 h-100" alt="{{ cane.nome }}" style="object-fit: cover; transition: transform 0.3s ease;">
                                {% else %}
                                <img src="https://placedog.net/500/280?id={{ cane.id }}" class="w-100 h-100" alt="{{ cane.nome }}" style="object-fit: cover; transition: transform 0.3s ease;" 
                                     onerror="this.onerror=null; this.src='https://place.dog/300/200?{{ cane.id }}'; 
                                     this.onerror=function(){
                                         // Array di razze di cani per diversificare le immagini
                                         var breeds = ['retriever-golden', 'retriever-labrador', 'husky', 'beagle', 'boxer', 'bulldog', 'chihuahua', 'collie', 'dachshund', 'dalmatian', 'germanshepherd', 'poodle', 'pug', 'rottweiler', 'terrier'];
                                         // Seleziona una razza in base all'ID del cane
                                         var breedIndex = {{ cane.id }} % breeds.length;
                                         var breed = breeds[breedIndex];
                                         // Usa immagini di cani da diverse fonti
                                         fetch('https://dog.ceo/api/breed/' + breed + '/images/random')
                                         .then(response => response.json())
                                         .then(data => {
                                             if (data.status === 'success') {
                                                 this.src = data.message;
                                             } else {
                                                 throw new Error('API error');
                                             }
                                         })
                                         .catch(error => {
                                             // Se l'API fallisce, usa un'immagine di fallback
                                             this.src='https://images.dog.ceo/breeds/' + breed + '/n02099601_{{ cane.id|stringformat:'04d' }}.jpg';
                                         });
                                         // Se l'immagine non può essere caricata, prova un'altra fonte
                                         this.onerror=function(){
                                             this.src='https://loremflickr.com/500/280/dog?lock={{ cane.id }}';
                                             this.onerror=function(){
                                                 this.parentNode.innerHTML='<div class=\'bg-primary bg-opacity-10 text-center p-5\' style=\'height: 250px;\'><i class=\'fas fa-dog fa-5x text-primary opacity-50 mt-4\'></i><p class=\'mt-3 text-muted\'>Foto in arrivo</p></div>';
                                             };
                                         };
                                     }">
                                {% endif %}

                                <!-- Overlay con età -->
                                <div class="position-absolute" style="bottom: 10px; left: 10px;">
                                    <span class="badge bg-{% if cane.eta and cane.eta < 2 %}success{% elif cane.eta and cane.eta < 8 %}info{% else %}warning{% endif %} rounded-pill px-3 py-2 shadow-sm">
                                        <i class="fas fa-birthday-cake me-1"></i>
                                        {% if cane.eta %}{{ cane.eta }} anni{% else %}Età sconosciuta{% endif %}
                                    </span>
                                </div>
                            </div>

                            <!-- Informazioni del cane -->
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h4 class="card-title mb-0 text-primary">{{ cane.nome }}</h4>
                                    <span class="badge bg-secondary rounded-pill">
                                        {% if cane.taglia %}{{ cane.get_taglia_display }}{% else %}Taglia non spec.{% endif %}
                                    </span>
                                </div>

                                <p class="text-muted mb-3">
                                    <i class="fas fa-paw me-2 text-primary"></i>{{ cane.razza }}
                                </p>

                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    {% if cane.compatibile_bambini %}
                                    <span class="badge bg-success rounded-pill">
                                        <i class="fas fa-child me-1"></i> Ama i bambini
                                    </span>
                                    {% endif %}
                                    {% if cane.compatibile_animali %}
                                    <span class="badge bg-success rounded-pill">
                                        <i class="fas fa-paw me-1"></i> Va d'accordo con altri animali
                                    </span>
                                    {% endif %}
                                </div>

                                <p class="card-text mb-3">{{ cane.descrizione|truncatewords:15 }}</p>

                                <div class="d-flex align-items-center text-muted small mb-3">
                                    <i class="fas fa-home me-2"></i>
                                    <span>{{ cane.canile.nome }}</span>
                                </div>
                            </div>

                            <!-- Footer con pulsante -->
                            <div class="card-footer bg-white border-0 p-4 pt-0">
                                <div class="d-grid">
                                    <a href="{% url 'dettaglio_cane' cane.id %}" class="btn btn-outline-primary">
                                        <i class="fas fa-paw me-2"></i>Scopri di più su {{ cane.nome }}
                                    </a>
                                </div>
                            </div>

                            <!-- Barra colorata in fondo -->
                            <div class="position-absolute" style="bottom: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));"></div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4>Non ci sono cani disponibili per l'adozione con i criteri selezionati.</h4>
                        <p class="text-muted">Prova a modificare i filtri o torna più tardi.</p>
                        <a href="{% url 'lista_cani' %}" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-redo me-2"></i>Reimposta filtri
                        </a>
                    </div>
                    {% endfor %}
                </div>
    </div>

    <!-- Filtri a destra -->
    <div class="col-lg-3">
        <div class="card border-0 shadow-sm rounded-3 overflow-hidden sticky-lg-top" style="top: 20px; z-index: 100;">
            <div class="card-header bg-primary text-white p-3">
                <h5 class="mb-0 d-flex align-items-center">
                    <i class="fas fa-filter me-2"></i>Trova il tuo amico ideale
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="get">
                    <!-- Ricerca -->
                    <div class="mb-4">
                        <label for="q" class="form-label fw-bold">
                            <i class="fas fa-search text-primary me-2"></i>Cerca
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control border-primary" id="q" name="q" value="{{ query }}" placeholder="Nome, razza o descrizione...">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Cane specifico -->
                    <div class="mb-4">
                        <label for="cane" class="form-label fw-bold">
                            <i class="fas fa-dog text-primary me-2"></i>Cane specifico
                        </label>
                        <select class="form-select" id="cane" name="cane">
                            <option value="">Tutti i cani</option>
                            {% for cane in cani_disponibili %}
                            <option value="{{ cane.id }}" {% if cane.id|stringformat:"i" == cane_id %}selected{% endif %}>{{ cane.nome }} - {{ cane.razza }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Canile -->
                    <div class="mb-4">
                        <label for="canile" class="form-label fw-bold">
                            <i class="fas fa-home text-primary me-2"></i>Canile
                        </label>
                        <select class="form-select" id="canile" name="canile">
                            <option value="">Tutti i canili</option>
                            {% for canile in canili %}
                            <option value="{{ canile.id }}" {% if canile.id|stringformat:"i" == canile_id %}selected{% endif %}>{{ canile.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <hr class="my-4">
                    <h6 class="text-uppercase text-muted mb-3">Caratteristiche</h6>

                    <!-- Taglia -->
                    <div class="mb-4">
                        <label for="taglia" class="form-label fw-bold">
                            <i class="fas fa-ruler text-primary me-2"></i>Taglia
                        </label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="taglia" id="taglia_tutte" value="" {% if not taglia %}checked{% endif %}>
                                <label class="form-check-label" for="taglia_tutte">Tutte</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="taglia" id="taglia_piccola" value="piccola" {% if taglia == 'piccola' %}checked{% endif %}>
                                <label class="form-check-label" for="taglia_piccola">Piccola</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="taglia" id="taglia_media" value="media" {% if taglia == 'media' %}checked{% endif %}>
                                <label class="form-check-label" for="taglia_media">Media</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="taglia" id="taglia_grande" value="grande" {% if taglia == 'grande' %}checked{% endif %}>
                                <label class="form-check-label" for="taglia_grande">Grande</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="taglia" id="taglia_molto_grande" value="molto_grande" {% if taglia == 'molto_grande' %}checked{% endif %}>
                                <label class="form-check-label" for="taglia_molto_grande">Molto grande</label>
                            </div>
                        </div>
                    </div>

                    <!-- Sesso -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-venus-mars text-primary me-2"></i>Sesso
                        </label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sesso" id="sesso_tutti" value="" {% if not sesso %}checked{% endif %}>
                                <label class="form-check-label" for="sesso_tutti">Tutti</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sesso" id="sesso_m" value="M" {% if sesso == 'M' %}checked{% endif %}>
                                <label class="form-check-label" for="sesso_m">
                                    <i class="fas fa-mars text-primary me-1"></i>Maschio
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sesso" id="sesso_f" value="F" {% if sesso == 'F' %}checked{% endif %}>
                                <label class="form-check-label" for="sesso_f">
                                    <i class="fas fa-venus text-danger me-1"></i>Femmina
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Età -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-birthday-cake text-primary me-2"></i>Età (anni)
                        </label>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="input-group">
                                    <span class="input-group-text">Min</span>
                                    <input type="number" class="form-control" id="eta_min" name="eta_min" value="{{ eta_min }}" min="0" max="20">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group">
                                    <span class="input-group-text">Max</span>
                                    <input type="number" class="form-control" id="eta_max" name="eta_max" value="{{ eta_max }}" min="0" max="20">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compatibilità -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-heart text-primary me-2"></i>Compatibilità
                        </label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="compatibile_bambini" name="compatibile_bambini" value="true" {% if compatibile_bambini %}checked{% endif %}>
                            <label class="form-check-label" for="compatibile_bambini">
                                <i class="fas fa-child text-success me-1"></i> Compatibile con bambini
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="compatibile_animali" name="compatibile_animali" value="true" {% if compatibile_animali %}checked{% endif %}>
                            <label class="form-check-label" for="compatibile_animali">
                                <i class="fas fa-paw text-success me-1"></i> Compatibile con altri animali
                            </label>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter me-2"></i>Applica filtri
                        </button>
                        <a href="{% url 'lista_cani' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i>Reimposta filtri
                        </a>
                    </div>
                </form>
            </div>
            <div class="card-footer bg-light p-3 text-center">
                <p class="mb-0 small">
                    <i class="fas fa-info-circle text-primary me-1"></i>
                    Hai bisogno di aiuto per scegliere? <a href="{% url 'contatti' %}">Contattaci</a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Paginazione -->
{% if page_obj.has_other_pages %}
<div class="mt-5 mb-4">
    <div class="col-lg-9">
        <div class="card border-0 shadow-sm rounded-3 p-3">
            <nav aria-label="Paginazione">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="mb-2 mb-md-0">
                        <p class="mb-0 text-muted">
                            <small>Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }} ({{ page_obj.paginator.count }} cani totali)</small>
                        </p>
                    </div>

                    <ul class="pagination pagination-sm mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort={{ sort_by }}&page=1" aria-label="Prima pagina">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort={{ sort_by }}&page={{ page_obj.previous_page_number }}" aria-label="Pagina precedente">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">
                                <i class="fas fa-angle-double-left"></i>
                            </span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">
                                <i class="fas fa-angle-left"></i>
                            </span>
                        </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort={{ sort_by }}&page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort={{ sort_by }}&page={{ page_obj.next_page_number }}" aria-label="Pagina successiva">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?q={{ query }}&cane={{ cane_id }}&canile={{ canile_id }}&taglia={{ taglia }}&sesso={{ sesso }}&eta_min={{ eta_min }}&eta_max={{ eta_max }}{% if compatibile_bambini %}&compatibile_bambini={{ compatibile_bambini }}{% endif %}{% if compatibile_animali %}&compatibile_animali={{ compatibile_animali }}{% endif %}&sort={{ sort_by }}&page={{ page_obj.paginator.num_pages }}" aria-label="Ultima pagina">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">
                                <i class="fas fa-angle-right"></i>
                            </span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">
                                <i class="fas fa-angle-double-right"></i>
                            </span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </nav>
        </div>
    </div>
</div>
{% endif %}
</div>
</div>
</div>
{% endblock %}
